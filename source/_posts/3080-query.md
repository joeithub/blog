title: SQLAlert 查询函数
tags:
  - SQLAlert
categories:
  - IT
author: Joe Tong
date: 2019-06-22 07:17:00
---
## 查询函数
本小节介绍 RDL 中查询 ES 相关函数，RDL 提供的查询函数使用 SQL 查询 ES，本文档中的示例只是对 SQL 简单的使用，SQLalert 中对 SQL 的支持请参阅 SQLAlert SQL 用户手册。

### query(sql, filter)
本函数使用指定的 SQL 语句查询 ES，并返回查询结果。如果指定了过滤条件，则对查询的结果进行过滤，返回过滤后的结果。函数接收 2 个参数：

- sql:    字符串类型，SQL 查询语句。
- filter: 字符串类型，查询结果过滤表达式。

在使用 query() 函数前，需要在脚本中定义 ES 服务器地址信息，该函数搜索 \__es_host\__ 和 \__es_host_query\__ 变量作为 ES 集群的地址，地址信息为字符串类型，且包含端口号。

该函数代码示例如下：

> ~~~ {.id .cs .numberLines}
> __es_host__ = "192.168.0.122:9222";
> 
> result = query("SELECT sip, sport, dip, sport FROM 'tcp-*' LIMIT5");
> pprint(result);
> ~~~

示例代码的输出内容如下：

> ~~~ {.id .cs}
> [
>     {
>         "sip": "192.168.0.13",
>         "sport": 56167,
>         "dip": "192.30.253.124"
>     },
>     {
>         "sip": "192.168.0.17",
>         "sport": 59312,
>         "dip": "180.149.132.165"
>     },
>     {
>         "sip": "192.168.0.17",
>         "sport": 59206,
>         "dip": "106.39.162.37"
>     },
>     {
>         "sip": "192.168.0.12",
>         "sport": 65223,
>         "dip": "64.233.189.139"
>     },
>     {
>         "sip": "192.168.0.13",
>         "sport": 56380,
>         "dip": "74.125.204.113"
>     }
> ]
> ~~~

为方便阅读，后续示例将使用 print_list() 函数打印查询结果，上述示例代码的结果使用 print_list() 函数打印出来如下：

> ~~~ {.id .cs}
> {"dip":"192.30.253.124","sip":"192.168.0.13","sport":56167}
> {"dip":"180.149.132.165","sip":"192.168.0.17","sport":59312}
> {"dip":"106.39.162.37","sip":"192.168.0.17","sport":59206}
> {"dip":"64.233.189.139","sip":"192.168.0.12","sport":65223}
> {"dip":"74.125.204.113","sip":"192.168.0.13","sport":56380}
> ~~~

query() 函数支持对查询结果的二次过滤，通过参数 filter 将 RDL 支持表达式传递给该函数即可，示例代码如下：

> ~~~ {.id .cs .numberLines}
> __es_host__ = "192.168.0.122:9222";
> 
> sql = "SELECT sip, sport, dip, sport FROM 'tcp-*' LIMIT 5";
> result = query(sql, "sip == '192.168.0.13'");
> print_list(result);
> ~~~

示例代码的输出内容如下：

> ~~~ {.id .cs}
> {"dip":"192.30.253.124","sip":"192.168.0.13","sport":56167}
> {"dip":"74.125.204.113","sip":"192.168.0.13","sport":56380}
> ~~~

需要注意，过滤表达式中，支持 RDL 所有支持的表达式，但不支持函数调用。

### query_avgby_num(sql, num, filter)
本函数使用指定的 SQL 语句查询 ES，并返回查询结果。如果指定了过滤条件，则对查询的结果进行过滤，返回过滤后的结果。该函数会将查询结果中所有的数值型字段，除以指定的数，然后再返回处理后的结果。其他方面与 query() 函数是一致的，query_avgby_num() 函数接收 3 个参数：

- sql:    字符串类型，SQL 查询语句。
- num:    数值类型，除数。
- filter: 字符串类型，查询结果过滤表达式。

请用户参阅 query() 函数示例，自行验证本函数。

### query_avgby_field(sql, name, filter)
本函数使用指定的 SQL 语句查询 ES，并返回查询结果。如果指定了过滤条件，则对查询的结果进行过滤，返回过滤后的结果。该函数会将查询结果中所有的数值型字段，除以指定的字段值，然后再返回处理后的结果，指定的字段必需为数值。其他方面与 query() 函数是一致的，query_avgby_field() 函数接收 3 个参数：

- sql:    字符串类型，SQL 查询语句。
- name:   字符串类型，除数字段名。
- filter: 字符串类型，查询结果过滤表达式。

请用户参阅 query() 函数示例，自行验证本函数。

